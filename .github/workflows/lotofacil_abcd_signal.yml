name: Lotofacil ABCD Prod (Dublin 04:30)

on:
  schedule:
    # DST-safe: roda 03:30 UTC (verão) e 04:30 UTC (inverno)
    - cron: "30 4 * * *"
  workflow_dispatch: {}

jobs:
  abcd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl requests

      - name: Guard (Mon–Sat, exactly 04:30 Dublin)
        id: guard
        run: |
          python - << 'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now = datetime.now(ZoneInfo("Europe/Dublin"))
          # Sunday skip (0=Mon ... 6=Sun)
          if now.weekday() == 6:
              ok = False
          else:
              ok = (now.hour == 4 and now.minute == 30)

          print(f"Dublin now: {now:%Y-%m-%d %H:%M} | should_run={ok}")

          with open("${GITHUB_OUTPUT}", "a", encoding="utf-8") as f:
              f.write(f"should_run={'true' if ok else 'false'}\n")
          PY

      - name: Run ABCD daily signal (fast)
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python fechamento_simples_v11_54_abcd_gate_plus_FIXED19.py \
            --abcd_daily_signal \
            --abcd_teimosinha_n 37 \
            --abcd_min_hits 14 \
            --abcd_gate_percentis 25,75 \
            --abcd_daily_json abcd_signal.json

      - name: Decide if gate_pass is True
        if: steps.guard.outputs.should_run == 'true'
        id: gate
        run: |
          python - << 'PY'
          import json
          with open("abcd_signal.json","r",encoding="utf-8") as f:
              sig = json.load(f)
          gate_pass = bool(sig.get("gate_pass"))
          print("gate_pass=", gate_pass)
          with open("${GITHUB_OUTPUT}", "a", encoding="utf-8") as g:
              g.write(f"gate_pass={'true' if gate_pass else 'false'}\n")
          PY

      - name: Run ABCD backtest + CSV (ONLY when PASS=True)
        if: steps.guard.outputs.should_run == 'true' && steps.gate.outputs.gate_pass == 'true'
        run: |
          python fechamento_simples_v11_54_abcd_gate_plus_FIXED19.py \
            --simular_abcd_gate \
            --abcd_teimosinha_n 37 \
            --abcd_min_hits 14 \
            --abcd_gate_percentis 25,75

      - name: Upload artifacts
        if: steps.guard.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: abcd-prod-${{ github.run_id }}
          path: |
            abcd_signal.json
            resultados_*.xlsx
            simulacao_abcd_gate_*.csv
          retention-days: 60

      - name: Email only if PASS=True
        if: steps.guard.outputs.should_run == 'true' && steps.gate.outputs.gate_pass == 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          python - << 'PY'
          import json, os, smtplib
          from email.mime.text import MIMEText

          with open("abcd_signal.json","r",encoding="utf-8") as f:
              sig = json.load(f)

          jogos = sig.get("jogos", {}) or {}
          gate  = sig.get("gate", {}) or {}

          body = []
          body.append("Lotofácil ABCD — GATE PASS = TRUE")
          body.append("")
          body.append(f"Último concurso: {sig.get('last_concurso')} | Data: {sig.get('last_data')}")
          body.append(f"Percentis: {gate.get('percentis')} | Faixa: {gate.get('faixa')} | Gap atual: {gate.get('gap_atual')}")
          body.append("")
          body.append("Jogos retornados pelo JSON:")
          for k, v in jogos.items():
              body.append(f"{k}: {v}")
          body = "\n".join(body)

          msg = MIMEText(body, "plain", "utf-8")
          msg["Subject"] = "Lotofácil ABCD: GATE PASS TRUE"
          msg["From"] = os.environ["SMTP_FROM"]
          msg["To"] = os.environ["SMTP_TO"]

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pwd  = os.environ["SMTP_PASS"]

          with smtplib.SMTP(host, port, timeout=30) as s:
              s.starttls()
              s.login(user, pwd)
              s.send_message(msg)

          print("Email sent.")
          PY
