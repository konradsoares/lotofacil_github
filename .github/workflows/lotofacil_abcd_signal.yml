name: Lotofacil ABCD Daily Signal

on:
  schedule:
    # Duas execuções pra cobrir horário de verão/inverno (Dublin)
    - cron: "30 4 * * *"   # 04:30 UTC -> 04:30 Dublin no inverno
  workflow_dispatch: {}

jobs:
  abcd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl requests

      - name: Guard (run only Mon–Sat at 04:30 Dublin)
        run: |
          python - << 'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo
          now = datetime.now(ZoneInfo("Europe/Dublin"))

          # 0=Mon ... 6=Sun
          if now.weekday() == 6:
              print("Skip: Sunday Dublin")
              raise SystemExit(0)

          # garante que só roda na execução “certa” (porque tem 2 crons)
          if not (now.hour == 4 and now.minute == 30):
              print(f"Skip: Dublin time {now:%H:%M} (not 04:30)")
              raise SystemExit(0)

          print("OK: Mon–Sat 04:30 Dublin")
          PY

      - name: Run ABCD daily signal (fast)
        run: |
          python fechamento_simples_v11_54_abcd_gate_plus_FIXED19.py \
            --abcd_daily_signal \
            --abcd_teimosinha_n 37 \
            --abcd_min_hits 14 \
            --abcd_gate_percentis 25,75 \
            --abcd_daily_json abcd_signal.json

      - name: Email only if PA requestsSS=False (include 4 jogos)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          python - << 'PY'
          import json, os, smtplib
          from email.mime.text import MIMEText

          with open("abcd_signal.json","r",encoding="utf-8") as f:
              sig = json.load(f)

          if not sig.get("gate_pass"):
              print("PASS=False -> no email")
              raise SystemExit(0)

          jogos = sig.get("jogos", {})
          gate = sig.get("gate", {})

          body = []
          body.append("Lotofácil ABCD — GATE PASS = FALSE")
          body.append("")
          body.append(f"Último concurso: {sig.get('last_concurso')} | Data: {sig.get('last_data')}")
          body.append(f"Percentis: {gate.get('percentis')} | Faixa: {gate.get('faixa')} | Gap atual: {gate.get('gap_atual')}")
          body.append("")
          body.append("4 jogos (15 dezenas):")
          for k in ["AB","AC","AD","BCD"]:
              v = jogos.get(k)
              if v:
                  body.append(f"{k}: {v}")
          body = "\n".join(body)

          msg = MIMEText(body, "plain", "utf-8")
          msg["Subject"] = "Lotofácil ABCD: GATE PASS TRUE"
          msg["From"] = os.environ["SMTP_FROM"]
          msg["To"] = os.environ["SMTP_TO"]

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pwd  = os.environ["SMTP_PASS"]

          with smtplib.SMTP(host, port) as s:
              s.starttls()
              s.login(user, pwd)
              s.send_message(msg)

          print("Email sent.")
          PY
