name: TEST - ABCD Email

on:
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl requests

      - name: Run ABCD daily signal
        run: |
          python fechamento_simples_v11_54_abcd_gate_plus_FIXED19.py \
            --abcd_daily_signal \
            --abcd_teimosinha_n 37 \
            --abcd_min_hits 14 \
            --abcd_gate_percentis 25,75 \
            --abcd_daily_json abcd_signal.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: abcd-test-${{ github.run_id }}
          path: |
            abcd_signal.json
            resultados_*.xlsx

      - name: Send TEST email (ignore gate_pass)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          python - << 'PY'
          import json, os, smtplib
          from email.mime.text import MIMEText

          # Debug: confirma se secrets chegaram (sem mostrar valores)
          for k in ["SMTP_HOST","SMTP_PORT","SMTP_USER","SMTP_PASS","SMTP_FROM","SMTP_TO"]:
              print(k, "OK" if os.environ.get(k) else "MISSING")

          with open("abcd_signal.json","r",encoding="utf-8") as f:
              sig = json.load(f)

          jogos = sig.get("jogos", {})
          gate = sig.get("gate", {})

          body = []
          body.append("TESTE EMAIL ABCD (ignorando gate_pass)")
          body.append("")
          body.append(f"gate_pass (real): {sig.get('gate_pass')}")
          body.append(f"Último concurso: {sig.get('last_concurso')} | Data: {sig.get('last_data')}")
          body.append(f"Percentis: {gate.get('percentis')} | Faixa: {gate.get('faixa')} | Gap atual: {gate.get('gap_atual')}")
          body.append("")
          body.append("4 jogos (15 dezenas):")
          body.append("Jogos retornados pelo JSON:")
          for k, v in (sig.get("jogos", {}) or {}).items():
              body.append(f"{k}: {v}")
          body = "\n".join(body)

          msg = MIMEText(body, "plain", "utf-8")
          msg["Subject"] = "TESTE - Lotofácil ABCD"
          msg["From"] = os.environ["SMTP_FROM"]
          msg["To"] = os.environ["SMTP_TO"]

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pwd  = os.environ["SMTP_PASS"]

          with smtplib.SMTP(host, port, timeout=30) as s:
              s.starttls()
              s.login(user, pwd)
              s.send_message(msg)

          print("Email enviado (teste).")
          PY
