name: Lotofacil ABCD (Prod) — Dublin 04:30

on:
  schedule:
    # DST-safe: roda 03:30 UTC (verão) e 04:30 UTC (inverno)
    - cron: "30 4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  abcd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl requests

      - name: Guard (Mon–Sat, exactly 04:30 Dublin)
        id: guard
        run: |
          python - << 'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now = datetime.now(ZoneInfo("Europe/Dublin"))
          # Sunday skip
          if now.weekday() == 6:
              ok = False
          else:
              ok = (now.hour == 4 and now.minute == 30)

          print(f"Dublin now: {now:%Y-%m-%d %H:%M} | should_run={ok}")

          with open("${GITHUB_OUTPUT}", "a", encoding="utf-8") as f:
              f.write(f"should_run={'true' if ok else 'false'}\n")
          PY

      - name: Run ABCD runner (daily snapshot + campaigns)
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python abcd_runner.py --teimosinha 37 --min_hits_stop 14 --gate_percentis 25,75

      - name: Build manifest.json for docs/results
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python - << 'PY'
          import json
          from pathlib import Path

          root = Path("docs/results")
          root.mkdir(parents=True, exist_ok=True)

          days = []
          for p in sorted(root.rglob("*.json")):
            if p.name == "manifest.json":
              continue
            # esperamos formato docs/results/YYYY/MM/YYYY-MM-DD.json
            try:
              label = p.stem  # YYYY-MM-DD
              # path relativo ao docs/
              rel = p.relative_to(Path("docs"))
              days.append({"label": label, "path": "./" + str(rel).replace("\\","/")})
            except Exception:
              pass

          out = {"days": days}
          (root / "manifest.json").write_text(json.dumps(out, ensure_ascii=False, indent=2), encoding="utf-8")
          print("manifest days:", len(days))
          PY
          
      - name: Commit docs updates
        if: steps.guard.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/

          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "ABCD: daily snapshot + campaigns"
          git push

      - name: Upload artifacts
        if: steps.guard.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: abcd-${{ github.run_id }}
          path: |
            abcd_signal.json
            resultados_*.xlsx
            simulacao_abcd_gate_*.csv
            runner_out.json
          retention-days: 60

      - name: Send email digest (only if runner created email_body.txt)
        if: steps.guard.outputs.should_run == 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          python - << 'PY'
          import os, smtplib
          from pathlib import Path
          from email.mime.text import MIMEText

          p = Path("email_body.txt")
          if not p.exists():
              print("No email_body.txt -> skipping email.")
              raise SystemExit(0)

          body = p.read_text(encoding="utf-8")
          msg = MIMEText(body, "plain", "utf-8")
          msg["Subject"] = "Lotofácil ABCD — Resumo Diário"
          msg["From"] = os.environ["SMTP_FROM"]
          msg["To"] = os.environ["SMTP_TO"]

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pwd  = os.environ["SMTP_PASS"]

          with smtplib.SMTP(host, port, timeout=30) as s:
              s.starttls()
              s.login(user, pwd)
              s.send_message(msg)

          print("Email sent.")
          PY
