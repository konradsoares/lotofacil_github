name: Lotofacil ABCD (Prod) — Dublin >= 04:30

on:
  schedule:
    # 06:00 UTC (não é "Dublin fixo" em DST, por isso o guard usa Europe/Dublin)
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  abcd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl requests

      - name: Guard (Mon–Sat, >= 04:30 Dublin, once per day)
        id: guard
        shell: bash
        run: |
          python - << 'PY' > guard_out.txt
          import json
          from datetime import datetime
          from zoneinfo import ZoneInfo
          from pathlib import Path

          now = datetime.now(ZoneInfo("Europe/Dublin"))
          today = now.strftime("%Y-%m-%d")

          if now.weekday() == 6:
              ok = False
              reason = "Sunday"
          else:
              ok = (now.hour > 4) or (now.hour == 4 and now.minute >= 30)
              reason = "before_04_30" if not ok else "time_ok"

          stamp_path = Path("docs/state/abcd_last_run.json")
          last = None
          if stamp_path.exists():
              try:
                  last = json.loads(stamp_path.read_text(encoding="utf-8")).get("last_run_dublin_date")
              except Exception:
                  last = None

          if ok and last == today:
              ok = False
              reason = f"already_ran_today ({today})"

          print(f"Dublin now: {now:%Y-%m-%d %H:%M} | last_run={last} | should_run={ok} | reason={reason}")
          print("should_run=" + ("true" if ok else "false"))
          print("reason=" + reason)
          PY

          cat guard_out.txt
          # pega as linhas should_run= e reason= e escreve no output
          grep '^should_run=' guard_out.txt >> "$GITHUB_OUTPUT"
          grep '^reason=' guard_out.txt >> "$GITHUB_OUTPUT"

      - name: Debug guard outputs
        run: |
          echo "guard.should_run='${{ steps.guard.outputs.should_run }}'"
          echo "guard.reason='${{ steps.guard.outputs.reason }}'"          

      - name: Ensure docs default files exist
        if: steps.guard.outputs.should_run == 'true'
        run: |
          mkdir -p docs/state docs/results
          if [ ! -f docs/state/abcd_campaigns.json ]; then
            cat > docs/state/abcd_campaigns.json << 'EOF'
            { "version": 1, "updated_at": null, "campaigns": [] }
            EOF
          fi

      - name: Run ABCD runner (daily snapshot + campaigns)
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python abcd_runner.py --teimosinha 37 --min_hits_stop 14 --gate_percentis 25,75

      - name: Stamp last run (Dublin date)
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python - << 'PY'
          import json
          from datetime import datetime
          from zoneinfo import ZoneInfo
          from pathlib import Path

          now = datetime.now(ZoneInfo("Europe/Dublin"))
          today = now.strftime("%Y-%m-%d")

          Path("docs/state").mkdir(parents=True, exist_ok=True)
          Path("docs/state/abcd_last_run.json").write_text(
              json.dumps({"last_run_dublin_date": today, "last_run_dublin_time": now.strftime("%H:%M")}, indent=2),
              encoding="utf-8"
          )
          print("Stamped:", today)
          PY

      - name: Build manifest.json for docs/results
        if: steps.guard.outputs.should_run == 'true'
        run: |
          python - << 'PY'
          import json
          from pathlib import Path

          root = Path("docs/results")
          root.mkdir(parents=True, exist_ok=True)

          days = []
          for p in sorted(root.rglob("*.json")):
            if p.name == "manifest.json":
              continue
            try:
              label = p.stem  # YYYY-MM-DD
              rel = p.relative_to(Path("docs"))
              days.append({"label": label, "path": "./" + str(rel).replace("\\","/")})
            except Exception:
              pass

          (root / "manifest.json").write_text(json.dumps({"days": days}, ensure_ascii=False, indent=2), encoding="utf-8")
          print("manifest days:", len(days))
          PY

      - name: Commit docs updates
        if: steps.guard.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/ abcd_signal.json runner_out.json email_body.txt resultados_*.xlsx simulacao_abcd_gate_*.csv || true

          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "ABCD: daily snapshot + campaigns"
          git push

      - name: Upload artifacts
        if: steps.guard.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: abcd-${{ github.run_id }}
          path: |
            abcd_signal.json
            resultados_*.xlsx
            simulacao_abcd_gate_*.csv
            runner_out.json
          retention-days: 60

      - name: Send email digest (only if runner created email_body.txt)
        if: steps.guard.outputs.should_run == 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          python - << 'PY'
          import os, smtplib
          from pathlib import Path
          from email.mime.text import MIMEText

          p = Path("email_body.txt")
          if not p.exists():
              print("No email_body.txt -> skipping email.")
              raise SystemExit(0)

          body = p.read_text(encoding="utf-8")
          msg = MIMEText(body, "plain", "utf-8")
          msg["Subject"] = "Lotofácil ABCD — Resumo Diário"
          msg["From"] = os.environ["SMTP_FROM"]
          msg["To"] = os.environ["SMTP_TO"]

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pwd  = os.environ["SMTP_PASS"]

          with smtplib.SMTP(host, port, timeout=30) as s:
              s.starttls()
              s.login(user, pwd)
              s.send_message(msg)

          print("Email sent.")
          PY
